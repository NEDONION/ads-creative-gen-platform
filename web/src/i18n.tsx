import React, { createContext, useContext, useEffect, useMemo, useState } from 'react';

type Lang = 'zh' | 'en';

type Messages = Record<string, Record<Lang, string>>;

const messages: Messages = {
  appTitle: { zh: 'LLM 广告创意全链路生成及实验平台', en: 'LLM Ads Creative & Experiment Platform' },
  navDashboard: { zh: '仪表盘', en: 'Dashboard' },
  navCreative: { zh: '创意生成', en: 'Creative' },
  navAssets: { zh: '素材管理', en: 'Assets' },
  navTasks: { zh: '任务管理', en: 'Tasks' },
  navExperiments: { zh: '实验列表', en: 'Experiments' },
  navExperimentNew: { zh: '新建实验', en: 'New Experiment' },
  navTraces: { zh: '调用链路', en: 'Traces' },
  headerDashboard: { zh: '仪表盘', en: 'Dashboard' },
  headerCreative: { zh: '创意生成', en: 'Creative' },
  headerAssets: { zh: '素材管理', en: 'Assets' },
  headerTasks: { zh: '任务管理', en: 'Tasks' },
  headerExperiments: { zh: '实验管理', en: 'Experiments' },
  headerExperimentNew: { zh: '新建实验', en: 'Create Experiment' },
  headerTraces: { zh: '调用链路', en: 'Model Traces' },
  welcomeTitle: { zh: '欢迎使用', en: 'Welcome' },
  welcomeAction: { zh: '立即开始', en: 'Get Started' },
  aboutTitle: { zh: '关于平台', en: 'About the Platform' },
  recentActivity: { zh: '最近活动', en: 'Recent Activity' },
  viewAll: { zh: '查看全部', en: 'View all' },
  loading: { zh: '加载中...', en: 'Loading...' },
  retry: { zh: '重试', en: 'Retry' },
  currentConfig: { zh: '当前配置', en: 'Current Config' },
  stepLabel: { zh: '步骤', en: 'Step' },
  product: { zh: '商品', en: 'Product' },
  notFilled: { zh: '未填写', en: 'Not set' },
  outputLanguage: { zh: '输出语言', en: 'Output language' },
  auto: { zh: '自动', en: 'Auto' },
  cta: { zh: 'CTA', en: 'CTA' },
  sellingPoints: { zh: '卖点', en: 'Selling Points' },
  pendingGen: { zh: '待生成', en: 'To be generated' },
  imageConfig: { zh: '图片配置', en: 'Image Config' },
  count: { zh: '数量', en: 'Count' },
  style: { zh: '风格', en: 'Style' },
  size: { zh: '尺寸', en: 'Size' },
  progress: { zh: '进度', en: 'Progress' },
  stepProduct: { zh: '商品', en: 'Product' },
  stepCopy: { zh: '文案', en: 'Selling Points' },
  stepCreative: { zh: '生成', en: 'Creative' },
  productName: { zh: '商品名称', en: 'Product name' },
  productPlaceholder: { zh: '如：智能手表 Pro', en: 'e.g. Smart Watch Pro' },
  outputLanguageLabel: { zh: '输出语言', en: 'Output language' },
  outputLangHint: { zh: '默认自动：根据商品名称检测中英文，可手动覆盖', en: 'Auto detect by product name, or override manually' },
  generateCopywriting: { zh: '生成文案', en: 'Generate copy' },
  generatingCopywriting: { zh: '生成中...', en: 'Generating...' },
  step1Title: { zh: '步骤 1：输入商品', en: 'Step 1: Product input' },
  step1Hint: { zh: '输入商品名称，系统自动生成 CTA 和卖点', en: 'Enter product name to auto-generate CTA and selling points' },
  step2Title: { zh: '步骤 2：选择/编辑文案', en: 'Step 2: Pick / edit copy' },
  step2Hint: { zh: '选择喜欢的 CTA 和卖点，可手动微调', en: 'Pick CTA and selling points, optionally edit' },
  ctaSection: { zh: 'CTA（行动号召）', en: 'CTA (call to action)' },
  editCTA: { zh: '编辑 CTA（可选）', en: 'Edit CTA (optional)' },
  ctaPlaceholder: { zh: '不填则使用选择的 CTA', en: 'Leave empty to use selected CTA' },
  sellingSection: { zh: '卖点（至少选一项）', en: 'Selling points (pick at least one)' },
  editSP: { zh: '编辑卖点（可选，一行一个）', en: 'Edit selling points (optional, one per line)' },
  spPlaceholder: { zh: '不填则使用勾选的卖点', en: 'Leave empty to use selected points' },
  back: { zh: '返回', en: 'Back' },
  confirmCopy: { zh: '确认文案', en: 'Confirm copy' },
  submitting: { zh: '提交中...', en: 'Submitting...' },
  step3Title: { zh: '步骤 3：生成创意', en: 'Step 3: Generate creatives' },
  step3Hint: { zh: '设置风格/图片，提交即可生成', en: 'Set style/images then submit' },
  creativeStyle: { zh: '创意风格', en: 'Style' },
  variantCount: { zh: '变体数量', en: 'Variants' },
  productImageUrl: { zh: '产品图片URL（可选）', en: 'Product image URL (optional)' },
  sizeLabel: { zh: '尺寸', en: 'Size' },
  sizePlaceholder: { zh: '例如: 1:1,9:16', en: 'e.g. 1:1,9:16' },
  variantConfigTitle: { zh: '变体配置（每张图自定义风格/提示词）', en: 'Variant configs (style/prompt per image)' },
  variantTitle: { zh: '变体', en: 'Variant' },
  inheritGlobal: { zh: '沿用全局风格', en: 'Inherit global' },
  bright: { zh: '明亮', en: 'Bright' },
  professional: { zh: '专业', en: 'Professional' },
  modern: { zh: '现代', en: 'Modern' },
  elegant: { zh: '优雅', en: 'Elegant' },
  vibrant: { zh: '活力', en: 'Vibrant' },
  customPrompt: { zh: '自定义提示词', en: 'Custom prompt' },
  promptPlaceholder: { zh: '可为空，留空则按 CTA/卖点自动拼提示词', en: 'Optional; leave empty to auto-build prompt' },
  startGenerate: { zh: '开始生成', en: 'Start generation' },
  restart: { zh: '重新开始', en: 'Restart' },
  generalStyle: { zh: '通用风格', en: 'General style' },
  styleBright: { zh: '明亮风格', en: 'Bright' },
  styleProfessional: { zh: '专业风格', en: 'Professional' },
  styleModern: { zh: '现代风格', en: 'Modern' },
  styleElegant: { zh: '优雅风格', en: 'Elegant' },
  statAssets: { zh: '总素材数', en: 'Total assets' },
  statTasks: { zh: '总任务数', en: 'Total tasks' },
  statExperiments: { zh: '总实验数', en: 'Total experiments' },
  welcomeP1: { zh: '开始创建您的第一个广告创意，体验 AI 驱动的高效创作流程。', en: 'Create your first ad creative and experience an AI-driven workflow.' },
  welcomeP2: { zh: '推荐流程：上传/填写商品信息 → 生成文案与图片 → 在实验中配置变体 → 观察指标与复盘。', en: 'Suggested: input product → generate copy & images → set variants in experiments → review metrics.' },
  welcomeHint: { zh: '支持 CTA/卖点覆盖、商品名过滤、任务详情查看提示词/风格。', en: 'Supports CTA/SP overrides, product filters, and viewing prompts/styles.' },
  aboutParagraph: { zh: 'AI 驱动的广告创意生成平台，整合文案、图像生成与实验投放。', en: 'AI-powered creative platform across copy, images, and experiments.' },
  feature1: { zh: '创意生成：多格式/风格自定义，提示词溯源', en: 'Creative gen: multi-format/style with prompt traceability' },
  feature2: { zh: '任务与素材：查看变体提示词/风格，分组展示', en: 'Tasks & assets: view per-variant prompts/styles, grouped display' },
  feature3: { zh: '实验：列表/创建分离，CTA/卖点覆盖，激活/停止与指标对比', en: 'Experiments: separate list/create, CTA/SP overrides, activate/stop with metrics' },
  feature4: { zh: '调用链路：追踪 Tongyi 关键步骤，来源为商品名', en: 'Traces: follow key Tongyi steps, source uses product name' },
  migrateTip: { zh: '如有新增字段，设置 AUTO_MIGRATE=true 可自动迁移。', en: 'Set AUTO_MIGRATE=true to auto-migrate when new fields are added.' },
  activityError: { zh: '加载最近活动失败', en: 'Failed to load recent activity' },
  noActivity: { zh: '暂无活动', en: 'No activity yet' },
  noActivityHint: { zh: '完成任务或生成素材后将在这里显示', en: 'Complete tasks or generate assets to see them here.' },
  activityMore: { zh: '仅显示最近 5 条，更多请前往任务/素材/实验列表查看。', en: 'Showing latest 5. See tasks/assets/experiments for more.' },
  refresh: { zh: '刷新', en: 'Refresh' },
  refreshing: { zh: '刷新中...', en: 'Refreshing...' },
  loadingMore: { zh: '加载中...', en: 'Loading...' },
  emptyAssets: { zh: '暂无素材', en: 'No assets yet' },
  emptyAssetsHint: { zh: '生成创意后素材将显示在这里', en: 'Generate creatives to see assets here.' },
  groupByProduct: { zh: '按商品/创意分组', en: 'Grouped by product/creative' },
  groupByHint: { zh: '点击卡片可查看该商品的所有素材', en: 'Click to view all assets of the product' },
  sellingPointsLabel: { zh: '卖点', en: 'Selling points' },
  titleLabel: { zh: '标题', en: 'Title' },
  pageInfo: { zh: '第 {current} / {total} 页', en: 'Page {current} / {total}' },
  totalAssetsText: { zh: '共 {n} 个素材', en: '{n} assets' },
  totalTasksText: { zh: '共 {n} 个任务', en: '{n} tasks' },
  emptyTasks: { zh: '暂无任务', en: 'No tasks yet' },
  emptyTasksHint: { zh: '创建创意生成任务后将显示在这里', en: 'Create a creative task to see it here.' },
  taskId: { zh: '任务ID', en: 'Task ID' },
  titleProduct: { zh: '标题/商品', en: 'Title/Product' },
  copywriting: { zh: '创意文案', en: 'Ad Text' },
  status: { zh: '状态', en: 'Status' },
  progressLabel: { zh: '进度', en: 'Progress' },
  createdAt: { zh: '创建时间', en: 'Created at' },
  completedAt: { zh: '完成时间', en: 'Completed at' },
  actions: { zh: '操作', en: 'Actions' },
  details: { zh: '详情', en: 'Details' },
  delete: { zh: '删除', en: 'Delete' },
  deleteConfirm: { zh: '确定删除该任务及其素材吗？', en: 'Delete this task and assets?' },
  deleteFailed: { zh: '删除失败', en: 'Delete failed' },
  backToList: { zh: '返回列表', en: 'Back to list' },
  refreshDetail: { zh: '刷新详情', en: 'Refresh detail' },
  taskDetail: { zh: '任务详情', en: 'Task Detail' },
  taskTitle: { zh: '标题', en: 'Title' },
  productNameLabel: { zh: '商品名称', en: 'Product' },
  variantConfig: { zh: '变体配置', en: 'Variant Configs' },
  promptLabel: { zh: '提示词', en: 'Prompt' },
  assetGenerated: { zh: '生成素材', en: 'Generated assets' },
  promptSet: { zh: '提示词已设置', en: 'Prompt set' },
  styleLabelShort: { zh: '风格', en: 'Style' },
  experimentList: { zh: '实验列表', en: 'Experiment List' },
  experimentListHint: { zh: '轻量面板：查看 / 激活 / 停止 / 指标', en: 'Quick panel: view / activate / stop / metrics' },
  createExperiment: { zh: '新建实验', en: 'Create Experiment' },
  createExperimentHint: { zh: '配置变体和权重，创建后可在实验列表查看', en: 'Configure variants/weights; view in list after creating' },
  nameLabel: { zh: '实验名称', en: 'Experiment Name' },
  productLabel: { zh: '商品名', en: 'Product' },
  noProduct: { zh: '暂无商品，请先创建任务', en: 'No products yet, create a task first' },
  variantConfigLabel: { zh: '变体配置', en: 'Variant Configs' },
  selectCreative: { zh: '请选择创意', en: 'Select creative' },
  creativeId: { zh: '创意ID', en: 'Creative ID' },
  weight: { zh: '权重', en: 'Weight' },
  ctaOverride: { zh: 'CTA（选择或覆盖）', en: 'CTA (select or override)' },
  useDefault: { zh: '使用创意默认', en: 'Use creative default' },
  creativeCTA: { zh: '创意：', en: 'Creative: ' },
  currentOverride: { zh: '当前覆盖：', en: 'Current override: ' },
  spOverride: { zh: '卖点（选择或覆盖）', en: 'Selling Points (select or override)' },
  addVariantBtn: { zh: '新增变体', en: 'Add Variant' },
  remove: { zh: '移除', en: 'Remove' },
  submitCreate: { zh: '创建实验', en: 'Create Experiment' },
  loadingShort: { zh: '加载中...', en: 'Loading...' },
  noExperiment: { zh: '暂无实验，先创建一个吧', en: 'No experiments yet, please create one.' },
  name: { zh: '名称', en: 'Name' },
  statusLabel: { zh: '状态', en: 'Status' },
  createdAtShort: { zh: '创建时间', en: 'Created' },
  experimentId: { zh: '实验ID', en: 'Experiment ID' },
  actionsShort: { zh: '操作', en: 'Actions' },
  view: { zh: '查看', en: 'View' },
  collapse: { zh: '收起', en: 'Collapse' },
  detailTitle: { zh: '实验详情', en: 'Experiment Detail' },
  detailHint: { zh: '时长 / 定义 / 变体素材', en: 'Duration / Definition / Variants' },
  activate: { zh: '激活', en: 'Activate' },
  activated: { zh: '已激活', en: 'Activated' },
  stop: { zh: '停止', en: 'Stop' },
  stopped: { zh: '已停止', en: 'Stopped' },
  refreshMetrics: { zh: '刷新指标', en: 'Refresh metrics' },
  duration: { zh: '时长', en: 'Duration' },
  startAt: { zh: '开始', en: 'Start' },
  endAt: { zh: '结束', en: 'End' },
  variantDef: { zh: '变体定义', en: 'Variant Definition' },
  metricsTitle: { zh: '当前指标', en: 'Current Metrics' },
  noMetrics: { zh: '当前实验暂无指标数据，可能尚未产生曝光/点击。', en: 'No metrics yet; impressions/clicks may not exist.' },
  noDataNotice: { zh: '当前实验暂无有效曝光/点击数据，可能是刚创建或未投放。稍后刷新即可查看。', en: 'No valid impressions/clicks yet; newly created or not delivered. Refresh later.' },
  totalImpressions: { zh: '总曝光', en: 'Total Impr.' },
  totalClicks: { zh: '总点击', en: 'Total Clicks' },
  avgCtr: { zh: '平均CTR', en: 'Avg CTR' },
  bestCtr: { zh: '最佳CTR', en: 'Best CTR' },
  aboveAvg: { zh: '高于均值', en: 'Above avg' },
  belowAvg: { zh: '低于均值', en: 'Below avg' },
  traceId: { zh: 'Trace ID', en: 'Trace ID' },
  filterStatus: { zh: '状态筛选', en: 'Status filter' },
  filter: { zh: '筛选', en: 'Filter' },
  source: { zh: '来源', en: 'Source' },
  result: { zh: '结果', en: 'Result' },
  runTime: { zh: '耗时', en: 'Duration' },
  startTime: { zh: '开始时间', en: 'Start Time' },
  endTime: { zh: '结束时间', en: 'End Time' },
  noTraces: { zh: '暂无链路', en: 'No traces' },
  steps: { zh: '步骤', en: 'Steps' },
  createFail: { zh: '创建失败', en: 'Create failed' },
  createSuccess: { zh: '创建成功', en: 'Created successfully' },
  fillName: { zh: '请填写实验名称', en: 'Please fill experiment name' },
  fillVariant: { zh: '请填写有效的创意ID和权重', en: 'Please provide valid creative and weight' },
  copySuccess: { zh: '已复制', en: 'Copied' },
  copyFail: { zh: '复制失败', en: 'Copy failed' },
  noThumb: { zh: '无缩略图', en: 'No thumbnail' },
  admin: { zh: '管理员', en: 'Admin' },
  basicInfo: { zh: '步骤 1：基础信息', en: 'Step 1: Basic Info' },
  basicInfoHint: { zh: '填写实验名称与商品名称，后续可在变体中指定创意', en: 'Set experiment/product; choose creatives in variants' },
  variantStep: { zh: '步骤 2：配置变体', en: 'Step 2: Configure variants' },
  variantStepHint: { zh: '为每个变体选择创意、权重，以及覆盖 CTA/卖点', en: 'Pick creative, weight, and CTA/SP overrides per variant' },
  summaryHint: { zh: '右侧实时汇总当前配置，便于检查', en: 'Right panel summarizes current selections' },
  variantLabel: { zh: '变体', en: 'Variant' },
  copyId: { zh: '复制', en: 'Copy' },
  traceListTitle: { zh: '调用列表', en: 'Trace List' },
  traceListHint: { zh: 'trace 概览', en: 'Trace overview' },
  query: { zh: '查询', en: 'Query' },
  all: { zh: '全部', en: 'All' },
  model: { zh: '模型', en: 'Model' },
  ops: { zh: '操作', en: 'Actions' },
  noData: { zh: '暂无数据', en: 'No data' },
  input: { zh: '输入', en: 'Input' },
  output: { zh: '输出', en: 'Output' },
  error: { zh: '错误', en: 'Error' },
  noSteps: { zh: '暂无步骤数据', en: 'No step data' },
  start: { zh: '开始', en: 'Start' },
  end: { zh: '结束', en: 'End' },
};

interface I18nValue {
  lang: Lang;
  t: (key: keyof typeof messages, fallback?: string) => string;
  toggle: () => void;
  setLang: (lang: Lang) => void;
}

const I18nContext = createContext<I18nValue | null>(null);

export const I18nProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [lang, setLangState] = useState<Lang>('zh');

  useEffect(() => {
    const stored = localStorage.getItem('lang');
    if (stored === 'en' || stored === 'zh') {
      setLangState(stored);
    }
  }, []);

  const setLang = (next: Lang) => {
    setLangState(next);
    localStorage.setItem('lang', next);
  };

  const value = useMemo<I18nValue>(
    () => ({
      lang,
      setLang,
      toggle: () => setLang(lang === 'zh' ? 'en' : 'zh'),
      t: (key, fallback) => (messages[key]?.[lang] || fallback || messages[key]?.zh || key),
    }),
    [lang]
  );

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
};

export const useI18n = () => {
  const ctx = useContext(I18nContext);
  if (!ctx) {
    throw new Error('useI18n must be used within I18nProvider');
  }
  return ctx;
};
