!function(){"use strict";class e{constructor(e){this.baseUrl=e.replace(/\/$/,"")}async get(e){const t=await fetch(`${this.baseUrl}${e}`,{method:"GET",mode:"cors",credentials:"omit",headers:{"Content-Type":"application/json"}});if(!t.ok)throw new Error(`API request failed: ${t.status} ${t.statusText}`);return t.json()}async post(e,t){const n=`${this.baseUrl}${e}`,i=t?JSON.stringify(t):void 0;console.log("[API POST] URL:",n),console.log("[API POST] Body:",i),console.log("[API POST] Headers:",{"Content-Type":"application/json"});const s=await fetch(n,{method:"POST",mode:"cors",credentials:"omit",headers:{"Content-Type":"application/json"},body:i});if(console.log("[API POST] Response status:",s.status,s.statusText),!s.ok){console.error("❌ [API POST ERROR] Request failed!"),console.error("❌ URL:",n),console.error("❌ Status:",s.status,s.statusText),console.error("❌ Body sent:",i);let e=`API request failed: ${s.status} ${s.statusText}`;try{const t=await s.json();console.error("❌ Error Response:",t),e+=` - ${JSON.stringify(t)}`}catch{try{const t=await s.text();console.error("❌ Error Response (text):",t),e+=` - ${t}`}catch{console.error("❌ Could not read error response")}}throw new Error(e)}return s.json()}sendBeacon(e,t){const n=`${this.baseUrl}${e}`,i=JSON.stringify(t);return console.log("[API BEACON] URL:",n),console.log("[API BEACON] Body:",i),fetch(n,{method:"POST",mode:"cors",credentials:"omit",headers:{"Content-Type":"application/json"},body:i,keepalive:!0}).then(async e=>{if(e.ok)console.log("✅ [API BEACON] Success:",e.status,e.statusText);else{console.error("❌ [API BEACON ERROR] Request failed!"),console.error("❌ URL:",n),console.error("❌ Status:",e.status,e.statusText),console.error("❌ Body sent:",i);try{const t=await e.json();console.error("❌ Error Response:",t)}catch{try{const t=await e.text();console.error("❌ Error Response (text):",t)}catch{console.error("❌ Could not read error response")}}}}).catch(e=>{console.error("❌ [API BEACON] Network error:",e),console.error("❌ URL:",n),console.error("❌ Body sent:",i)}),!0}}const t=e=>{if("string"==typeof e){const t=Number(e);if(!Number.isNaN(t)&&Number.isFinite(t))return t}return e};class n{constructor(e,t,n){this.observer=null,this.trackedIds=new Set,this.timers=new Map,this.apiClient=e,this.experimentId=t,this.anonId=n}track(e,n){const i=t(n);console.log("[Impression] Starting to track element:",e,"creative_id:",n),this.trackedIds.has(i)?console.log("[Impression] Already tracked, skipping:",i):(this.observer||(console.log("[Impression] Creating IntersectionObserver"),this.observer=new IntersectionObserver(e=>{e.forEach(e=>{const t=e.target,n=t.getAttribute("data-creative-id");if(console.log("[Impression] Observer callback:",{creative_id:n,isIntersecting:e.isIntersecting,intersectionRatio:e.intersectionRatio,boundingClientRect:e.boundingClientRect}),n)if(e.isIntersecting&&e.intersectionRatio>=.5){if(!this.timers.has(t)){console.log("[Impression] Element visible ≥50%, starting 500ms timer for:",n);const e=window.setTimeout(()=>{console.log("[Impression] Timer fired, sending impression for:",n),this.sendImpression(n),this.timers.delete(t)},500);this.timers.set(t,e)}}else{const e=this.timers.get(t);e&&(console.log("[Impression] Element no longer visible, clearing timer for:",n),window.clearTimeout(e),this.timers.delete(t))}else console.warn("[Impression] No creative_id attribute found on element")})},{threshold:.5})),e.setAttribute("data-creative-id",String(i)),console.log("[Impression] Observing element with creative_id:",i),this.observer.observe(e))}sendImpression(e){const n=t(e);if(this.trackedIds.has(n))return;this.trackedIds.add(n);const i={creative_id:n};console.log("[Impression] Sending:",i),this.apiClient.post(`/experiments/${this.experimentId}/hit`,i).catch(e=>{console.error("❌❌❌ [IMPRESSION FAILED] ❌❌❌"),console.error("❌ Creative ID:",n),console.error("❌ Experiment ID:",this.experimentId),console.error("❌ Error:",e.message),console.error("❌ Full error:",e)})}destroy(){this.observer&&(this.observer.disconnect(),this.observer=null),this.timers.forEach(e=>window.clearTimeout(e)),this.timers.clear()}}class i{constructor(e,t,n){this.apiClient=e,this.experimentId=t,this.anonId=n}track(e){const n={creative_id:t(e)};console.log("[Click] Sending:",n),this.apiClient.sendBeacon(`/experiments/${this.experimentId}/click`,n)}}class s{constructor(t){this.hasCachedRender=!1,this.cachedCreative=null,this.creativeId=null,this.isOpen=!1,this.toastTimer=null,this.config=t,this.apiClient=new e(t.apiBase),this.anonId=this.getOrCreateAnonId(),this.impressionTracker=new n(this.apiClient,t.experimentId,this.anonId),this.clickTracker=new i(this.apiClient,t.experimentId,this.anonId);const s=Number.isFinite(this.config.cacheTTL)?this.config.cacheTTL:6e5;this.cacheTTL=Math.max(0,s),this.cacheKey=this.shouldUseCache()?this.buildCacheKey():null,this.container=document.createElement("div"),this.container.id="experiment-widget-root",this.shadowRoot=this.container.attachShadow({mode:"open"});const o=document.createElement("style");o.textContent="\n  * {\n    box-sizing: border-box;\n    margin: 0;\n    padding: 0;\n  }\n\n  .exp-widget-container {\n    position: fixed;\n    top: 160px;\n    right: 20px;\n    bottom: auto;\n    left: auto;\n    transform: none;\n    z-index: 999999;\n    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;\n    font-size: 14px;\n    line-height: 1.5;\n  }\n\n  .exp-widget-badge {\n    width: 60px;\n    height: 60px;\n    border-radius: 16px;\n    background: linear-gradient(135deg, #0f172a 0%, #3b82f6 60%, #22d3ee 100%);\n    cursor: pointer;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    flex-direction: column;\n    color: white;\n    gap: 2px;\n    padding: 8px;\n    font-size: 13px;\n    transition: transform 0.2s, box-shadow 0.2s;\n  }\n\n  .exp-widget-badge-icon {\n    font-weight: 700;\n    letter-spacing: 0.5px;\n  }\n\n  .exp-widget-badge-label {\n    font-size: 11px;\n    opacity: 0.85;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n  }\n\n  .exp-widget-badge:hover {\n    transform: scale(1.05);\n    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);\n  }\n\n  .exp-widget-badge.hidden {\n    display: none;\n  }\n\n  .exp-widget-panel {\n    width: 320px;\n    background: white;\n    border-radius: 16px;\n    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);\n    overflow: hidden;\n    display: none;\n    flex-direction: column;\n  }\n\n  .exp-widget-panel.visible {\n    display: flex;\n  }\n\n  .exp-widget-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 12px 16px;\n    background: #f8fafc;\n    border-bottom: 1px solid #e2e8f0;\n  }\n\n  .exp-widget-header-title {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    font-size: 12px;\n    color: #64748b;\n    font-weight: 500;\n  }\n\n  .exp-widget-chip {\n    font-size: 11px;\n    color: #0f172a;\n    background: #e0f2fe;\n    border: 1px solid #bae6fd;\n    border-radius: 999px;\n    padding: 3px 8px;\n    font-weight: 600;\n    letter-spacing: 0.2px;\n  }\n\n  .exp-widget-toggle {\n    background: #e2e8f0;\n    border: none;\n    padding: 6px 12px;\n    border-radius: 12px;\n    font-size: 11px;\n    color: #475569;\n    cursor: pointer;\n    font-weight: 500;\n    transition: background 0.2s;\n  }\n\n  .exp-widget-toggle:hover {\n    background: #cbd5e1;\n  }\n\n  .exp-widget-body {\n    padding: 16px;\n  }\n\n  .exp-widget-status {\n    text-align: center;\n    padding: 24px;\n    color: #64748b;\n  }\n\n  .exp-widget-card {\n    display: none;\n    flex-direction: row;\n    gap: 12px;\n    cursor: pointer;\n    transition: transform 0.2s;\n  }\n\n  .exp-widget-card.visible {\n    display: flex;\n  }\n\n  .exp-widget-card:hover {\n    transform: translateY(-2px);\n  }\n\n  .exp-widget-thumbnail {\n    width: 80px;\n    height: 80px;\n    border-radius: 12px;\n    background: linear-gradient(135deg, #38bdf8, #a78bfa);\n    flex-shrink: 0;\n    background-size: cover;\n    background-position: center;\n  }\n\n  .exp-widget-info {\n    flex: 1;\n    display: flex;\n    flex-direction: column;\n    gap: 4px;\n    min-width: 0;\n  }\n\n  .exp-widget-eyebrow {\n    font-size: 10px;\n    color: #94a3b8;\n    font-weight: 500;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n  }\n\n  .exp-widget-title {\n    font-size: 14px;\n    font-weight: 600;\n    color: #0f172a;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    display: -webkit-box;\n    -webkit-line-clamp: 2;\n    -webkit-box-orient: vertical;\n  }\n\n  .exp-widget-meta {\n    font-size: 12px;\n    color: #64748b;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n\n  .exp-widget-desc {\n    font-size: 12px;\n    color: #3b82f6;\n    font-weight: 500;\n    margin-top: 4px;\n  }\n\n  .exp-widget-toast {\n    position: fixed;\n    top: 160px;\n    right: 20px;\n    bottom: auto;\n    left: auto;\n    transform: none;\n    background: #0f172a;\n    color: white;\n    padding: 12px 16px;\n    border-radius: 8px;\n    font-size: 13px;\n    max-width: 280px;\n    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n    opacity: 0;\n    transition: opacity 0.25s;\n    display: none;\n  }\n\n  .exp-widget-toast.visible {\n    display: block;\n    opacity: 1;\n  }\n",this.shadowRoot.appendChild(o),this.createUI();const r=this.loadCachedCreative();this.cachedCreative=r,document.body.appendChild(this.container),r&&(this.hasCachedRender=!0,this.renderCreative(r)),this.assign()}getOrCreateAnonId(){const e="experiment_widget_anon_id";let t=localStorage.getItem(e);return t||(t=`anon_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,localStorage.setItem(e,t)),t}createUI(){const e=document.createElement("div");e.className="exp-widget-container",e.innerHTML='\n      <div class="exp-widget-badge" id="badge" aria-label="A/B experiment ads">\n        <span class="exp-widget-badge-icon">A/B</span>\n        <span class="exp-widget-badge-label">Ads</span>\n      </div>\n      <div class="exp-widget-panel" id="panel">\n        <div class="exp-widget-header">\n          <div class="exp-widget-header-title">\n            <span>Sponsored</span>\n            <span class="exp-widget-chip">A/B Ads</span>\n          </div>\n          <button class="exp-widget-toggle" id="toggle">Hide</button>\n        </div>\n        <div class="exp-widget-body" id="body">\n          <div class="exp-widget-status" id="status">Assigning...</div>\n          <div class="exp-widget-card" id="card">\n            <div class="exp-widget-thumbnail" id="thumbnail"></div>\n            <div class="exp-widget-info">\n              <div class="exp-widget-eyebrow">A/B Experiment</div>\n              <div class="exp-widget-title" id="title"></div>\n              <div class="exp-widget-meta" id="meta"></div>\n              <div class="exp-widget-desc" id="desc"></div>\n            </div>\n          </div>\n        </div>\n      </div>\n      <div class="exp-widget-toast" id="toast"></div>\n    ',this.shadowRoot.appendChild(e),this.attachEventListeners()}attachEventListeners(){const e=this.shadowRoot.getElementById("badge"),t=this.shadowRoot.getElementById("toggle"),n=this.shadowRoot.getElementById("card");null==e||e.addEventListener("click",()=>this.togglePanel(!0)),null==t||t.addEventListener("click",()=>this.togglePanel()),null==n||n.addEventListener("click",()=>this.handleCardClick())}togglePanel(e){this.isOpen=e??!this.isOpen;const t=this.shadowRoot.getElementById("badge"),n=this.shadowRoot.getElementById("panel"),i=this.shadowRoot.getElementById("toggle");t&&n&&i&&(this.isOpen?(t.classList.add("hidden"),n.classList.add("visible"),i.textContent="Hide"):(t.classList.remove("hidden"),n.classList.remove("visible"),i.textContent="Show"))}async assign(){const e=this.shadowRoot.getElementById("status"),t=this.shadowRoot.getElementById("card");if(e&&t){this.hasCachedRender?e.style.display="none":(e.style.display="block",e.textContent="Assigning...",t.classList.remove("visible"));try{const t=this.config.randomAssignment?`random_${Date.now()}_${Math.random().toString(36).substr(2,9)}`:this.config.userKey||this.anonId,n=await this.apiClient.get(`/experiments/${this.config.experimentId}/assign?user_key=${encodeURIComponent(t)}`),i=this.extractCreativePayload(n);if(i){if(!!this.cachedCreative&&this.isSameCreative(this.cachedCreative,i))return this.cachedCreative=i,void this.refreshCacheTimestamp();this.cachedCreative=i,this.saveCreativeToCache(i),this.hasCachedRender=!1,this.renderCreative(i)}else e.textContent="No creative assigned"}catch(n){const t=n instanceof Error?n.message:"Unknown error";console.error("❌❌❌ [ASSIGNMENT FAILED] ❌❌❌"),console.error("❌ Experiment ID:",this.config.experimentId),console.error("❌ Error:",t),console.error("❌ Full error:",n),this.hasCachedRender||(e.textContent=`Assignment error: ${t}`)}}}renderCreative(e){const t=this.normalizeCreativeId(e.creative_id);this.creativeId=t;const n=this.shadowRoot.getElementById("status"),i=this.shadowRoot.getElementById("card"),s=this.shadowRoot.getElementById("thumbnail"),o=this.shadowRoot.getElementById("title"),r=this.shadowRoot.getElementById("meta"),a=this.shadowRoot.getElementById("desc");if(!(n&&i&&s&&o&&r&&a))return;n.style.display="none";const d=e.title||e.product_name||`Creative #${this.creativeId}`;o.textContent=d;const c=e.selling_points&&e.selling_points.length>0?e.selling_points.slice(0,2).join(" · "):"";r.textContent=c||e.product_name||"Tap to view details",a.textContent=e.cta_text||"Learn more",e.image_url?(s.style.backgroundImage=`url(${e.image_url})`,s.style.backgroundSize="cover"):(s.style.backgroundImage="linear-gradient(135deg, #38bdf8, #a78bfa)",s.style.backgroundSize="auto"),i.classList.add("visible"),this.impressionTracker.track(i,t)}handleCardClick(){if(!this.creativeId)return;this.clickTracker.track(this.creativeId);const e=this.shadowRoot.getElementById("toast");e&&(e.textContent="Click collected for A/B experiment. Thanks for your feedback.",e.classList.add("visible"),this.toastTimer&&window.clearTimeout(this.toastTimer),this.toastTimer=window.setTimeout(()=>{e.classList.remove("visible")},1800))}destroy(){this.impressionTracker.destroy(),this.toastTimer&&window.clearTimeout(this.toastTimer),this.container.remove()}normalizeCreativeId(e){if("string"==typeof e){const t=Number(e);if(!Number.isNaN(t)&&Number.isFinite(t))return t}return e}extractCreativePayload(e){var t;return(null==e?void 0:e.creative_id)?e:(null==e?void 0:e.data)&&(null==(t=e.data)?void 0:t.creative_id)?e.data:null}shouldUseCache(){return!this.config.disableCache&&!this.config.randomAssignment}buildCacheKey(){const e=this.config.userKey||this.anonId;return`exp_widget_cache_${this.config.experimentId}_${e}`}loadCachedCreative(){if(!this.cacheKey||0===this.cacheTTL)return null;try{const e=localStorage.getItem(this.cacheKey);if(!e)return null;const t=JSON.parse(e);if(!(null==t?void 0:t.data)||!t.ts)return null;return Date.now()-t.ts>this.cacheTTL?(localStorage.removeItem(this.cacheKey),null):t.data}catch(e){return console.warn("[ExperimentWidget] Failed to read cache",e),null}}saveCreativeToCache(e){if(!this.cacheKey||0===this.cacheTTL)return;const t={data:e,ts:Date.now()};try{localStorage.setItem(this.cacheKey,JSON.stringify(t))}catch(n){console.warn("[ExperimentWidget] Failed to save cache",n)}}refreshCacheTimestamp(){if(this.cacheKey&&0!==this.cacheTTL)try{const e=localStorage.getItem(this.cacheKey);if(!e)return;const t=JSON.parse(e);if(!(null==t?void 0:t.data))return;t.ts=Date.now(),localStorage.setItem(this.cacheKey,JSON.stringify(t))}catch(e){console.warn("[ExperimentWidget] Failed to refresh cache timestamp",e)}}isSameCreative(e,t){return this.normalizeCreativeId(e.creative_id)===this.normalizeCreativeId(t.creative_id)}}!function(){if(window.__EXPERIMENT_WIDGET_LOADED__)return void console.warn("[ExperimentWidget] Already loaded, skipping initialization");window.__EXPERIMENT_WIDGET_LOADED__=!0;const e=document.currentScript;if(!e)return void console.error("[ExperimentWidget] Cannot find script tag, initialization failed");const t=e.dataset.apiBase,n=e.dataset.experimentId,i=e.dataset.userKey,o="true"===e.dataset.randomAssignment,r=e.dataset.cacheTtl,a="true"===e.dataset.disableCache,d=r?Number(r):void 0,c=Number.isFinite(d)?d:void 0;if(!t)return void console.error("[ExperimentWidget] Missing required attribute: data-api-base");if(!n)return void console.error("[ExperimentWidget] Missing required attribute: data-experiment-id");const l={apiBase:t,experimentId:n,userKey:i,randomAssignment:o,cacheTTL:c,disableCache:a};"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new s(l)}):new s(l)}()}();
