<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹¿å‘Šåˆ›æ„ç”Ÿæˆå¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .subtitle {
            opacity: 0.8;
            font-size: 0.9rem;
        }

        .main-content {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            min-height: 100px;
            font-family: monospace;
            resize: vertical;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }

        button:hover {
            background: #2980b9;
        }

        .btn-danger {
            background: #e74c3c;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .response-section {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
            background: #fafafa;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .response-body {
            background: white;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
        }

        .image-preview-container {
            margin-top: 15px;
        }

        .image-preview {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .image-item {
            display: inline-block;
            text-align: center;
            margin-bottom: 10px;
        }

        .image-item img {
            max-width: 200px;
            max-height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            object-fit: contain;
        }

        .image-url {
            font-size: 0.8em;
            word-break: break-all;
            margin-top: 5px;
            color: #666;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 200px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .asset-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.2s;
        }

        .asset-card:hover {
            transform: translateY(-5px);
        }

        .asset-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }

        .asset-info {
            padding: 15px;
        }

        .asset-id {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 8px;
            word-break: break-all;
        }

        .asset-format {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 8px;
        }

        .asset-dimensions {
            font-size: 0.9rem;
            color: #2c3e50;
        }

        .asset-url {
            margin-top: 10px;
            font-size: 0.8rem;
            color: #7f8c8d;
            word-break: break-all;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .page-btn {
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .page-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .current-page {
            padding: 0 10px;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
            color: #7f8c8d;
        }

        .error {
            background: #fadbd8;
            color: #c0392b;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 5px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .api-endpoints {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        .endpoint-btn {
            display: inline-block;
            padding: 5px 10px;
            margin: 5px;
            background: #95a5a6;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
        }

        .endpoint-btn:hover {
            background: #7f8c8d;
        }

        .error-message {
            color: #e74c3c;
            background: #fadbd8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>å¹¿å‘Šåˆ›æ„ç”Ÿæˆå¹³å°</h1>
            <div class="subtitle">API æµ‹è¯•ç•Œé¢</div>
        </header>

        <div class="main-content">
            <!-- APIæµ‹è¯•éƒ¨åˆ† -->
            <div id="apiTestSection">
                <form id="apiForm">
                    <div class="form-group">
                        <label for="apiEndpoint">API æ¥å£:</label>
                        <select id="apiEndpoint" required>
                            <option value="">é€‰æ‹©æ¥å£</option>
                            <option value="/health">GET /health - å¥åº·æ£€æŸ¥</option>
                            <option value="/api/v1/ping">GET /api/v1/ping - Pingæµ‹è¯•</option>
                            <option value="/api/v1/creative/generate">POST /api/v1/creative/generate - ç”Ÿæˆåˆ›æ„</option>
                            <option value="/api/v1/creative/task">GET /api/v1/creative/task/{id} - æŸ¥è¯¢ä»»åŠ¡</option>
                            <option value="/api/v1/creative/assets">GET /api/v1/creative/assets - è·å–æ‰€æœ‰ç´ æ</option>
                        </select>
                    </div>

                    <div class="form-group" id="taskIdInput" style="display: none;">
                        <label for="taskId">ä»»åŠ¡ID:</label>
                        <input type="text" id="taskId" placeholder="è¾“å…¥ä»»åŠ¡ID">
                    </div>

                    <div class="form-group" id="requestBodySection" style="display: none;">
                        <label for="requestBody">è¯·æ±‚ä½“ (JSON):</label>
                        <textarea id="requestBody" placeholder='è¾“å…¥JSONæ•°æ®, å¦‚: {"title": "æµ‹è¯•åˆ›æ„"}'></textarea>
                    </div>

                    <div>
                        <button type="submit" id="sendBtn">
                            <span id="sendText">å‘é€è¯·æ±‚</span>
                            <span id="loadingSpinner" class="loading" style="display: none;"></span>
                        </button>
                        <button type="button" class="btn-danger" id="clearBtn">æ¸…ç©º</button>
                        <button type="button" class="btn-success" id="viewAssetsBtn" onclick="showAssetsView()">ç´ æç®¡ç†</button>
                    </div>
                </form>

                <div class="api-endpoints">
                    <h3>å¿«é€Ÿç¤ºä¾‹:</h3>
                    <a href="#" class="endpoint-btn" onclick="loadExample('/health', 'GET')">å¥åº·æ£€æŸ¥</a>
                    <a href="#" class="endpoint-btn" onclick="loadExample('/api/v1/ping', 'GET')">Pingæµ‹è¯•</a>
                    <a href="#" class="endpoint-btn" onclick="loadExample('/api/v1/creative/generate', 'POST')">ç”Ÿæˆåˆ›æ„ç¤ºä¾‹</a>
                </div>
            </div>

            <!-- ç´ æç®¡ç†éƒ¨åˆ† -->
            <div id="assetsManagementSection" style="display: none;">
                <h2>ğŸ¨ å¹¿å‘Šç´ æç®¡ç†</h2>

                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalAssets">0</div>
                        <div class="stat-label">æ€»ç´ ææ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="todayAssets">0</div>
                        <div class="stat-label">ä»Šæ—¥æ–°å¢</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalTasks">0</div>
                        <div class="stat-label">ä»»åŠ¡æ•°</div>
                    </div>
                </div>

                <div class="controls">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="formatFilter">æ ¼å¼ç­›é€‰:</label>
                            <select id="formatFilter">
                                <option value="">å…¨éƒ¨æ ¼å¼</option>
                                <option value="1:1">1:1 (æ­£æ–¹å½¢)</option>
                                <option value="16:9">16:9 (æ¨ªå±)</option>
                                <option value="9:16">9:16 (ç«–å±)</option>
                                <option value="4:3">4:3 (æ ‡å‡†)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="taskFilter">ä»»åŠ¡IDç­›é€‰:</label>
                            <input type="text" id="taskFilter" placeholder="è¾“å…¥ä»»åŠ¡ID">
                        </div>
                        <div class="form-group">
                            <label for="pageSize">æ¯é¡µæ•°é‡:</label>
                            <select id="pageSize">
                                <option value="12">12</option>
                                <option value="24" selected>24</option>
                                <option value="48">48</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <button onclick="loadAssets()">æœç´¢</button>
                        <button class="btn-refresh" onclick="refreshAssets()">åˆ·æ–°</button>
                        <button onclick="clearFilters()">æ¸…ç©ºç­›é€‰</button>
                        <button class="btn-success" onclick="showAPITestView()">APIæµ‹è¯•</button>
                    </div>
                </div>

                <div id="loading" class="loading" style="display: none;">åŠ è½½ä¸­...</div>
                <div id="error" class="error" style="display: none;"></div>

                <div id="assetsContainer" class="assets-grid">
                    <!-- ç´ æå¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>

                <div class="pagination" id="pagination">
                    <!-- åˆ†é¡µæ§ä»¶å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                </div>
            </div>

            <!-- APIå“åº”éƒ¨åˆ† (ä¿æŒåœ¨åº•éƒ¨) -->
            <div id="responseSection">
                <div class="response-header">
                    <h3>å“åº”ç»“æœ</h3>
                    <div id="responseStatus" class="status-badge status-info" style="display: none;">ç­‰å¾…å“åº”</div>
                </div>
                <div id="responseBody" class="response-body">ç­‰å¾…è¯·æ±‚...</div>
                <div id="imagePreviewContainer" class="image-preview-container" style="display: none;">
                    <h4>ç”Ÿæˆçš„åˆ›æ„å›¾ç‰‡</h4>
                    <div id="imagePreview" class="image-preview"></div>
                </div>
                <div id="responseTime" style="margin-top: 10px; font-size: 0.9em; color: #666; display: none;"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const apiEndpoint = document.getElementById('apiEndpoint');
            const taskIdInput = document.getElementById('taskIdInput');
            const requestBodySection = document.getElementById('requestBodySection');
            const requestBody = document.getElementById('requestBody');
            const apiForm = document.getElementById('apiForm');
            const sendBtn = document.getElementById('sendBtn');
            const sendText = document.getElementById('sendText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const responseStatus = document.getElementById('responseStatus');
            const responseBody = document.getElementById('responseBody');
            const responseTime = document.getElementById('responseTime');
            const clearBtn = document.getElementById('clearBtn');

            // å¤„ç†æ¥å£é€‰æ‹©
            apiEndpoint.addEventListener('change', function() {
                const endpoint = this.value;

                // æ˜¾ç¤º/éšè—ä»»åŠ¡IDè¾“å…¥æ¡†
                if (endpoint.includes('/creative/task')) {
                    taskIdInput.style.display = 'block';
                } else {
                    taskIdInput.style.display = 'none';
                }

                // æ˜¾ç¤º/éšè—è¯·æ±‚ä½“
                if (endpoint.includes('generate') || endpoint.includes('create') || endpoint.includes('update')) {
                    requestBodySection.style.display = 'block';
                } else {
                    requestBodySection.style.display = 'none';
                }
            });

            // æ¸…ç©ºè¡¨å•
            clearBtn.addEventListener('click', function() {
                apiEndpoint.value = '';
                document.getElementById('taskId').value = '';
                requestBody.value = '';
                responseBody.textContent = 'ç­‰å¾…è¯·æ±‚...';
                responseStatus.style.display = 'none';
                responseTime.style.display = 'none';
                taskIdInput.style.display = 'none';
                requestBodySection.style.display = 'none';
            });

            // å¤„ç†è¡¨å•æäº¤
            apiForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const endpoint = apiEndpoint.value;
                const taskId = document.getElementById('taskId').value.trim();
                const body = requestBody.value.trim();

                if (!endpoint) {
                    alert('è¯·é€‰æ‹©APIæ¥å£');
                    return;
                }

                let url = `http://localhost:4000${endpoint}`;

                // ä¸“é—¨å¤„ç†ä»»åŠ¡æŸ¥è¯¢æ¥å£
                if (endpoint.includes('/creative/task')) {
                    if (!taskId) {
                        alert('æŸ¥è¯¢ä»»åŠ¡æ—¶è¯·æä¾›ä»»åŠ¡ID');
                        return;
                    }
                    // æ­£ç¡®æ„å»ºä»»åŠ¡æŸ¥è¯¢URLï¼Œåç«¯è·¯ç”±æ˜¯ /api/v1/creative/task/:id
                    url = `http://localhost:4000/api/v1/creative/task/${taskId}`;
                }

                // ç¡®å®šHTTPæ–¹æ³•
                const isGet = endpoint.startsWith('/health') || endpoint.includes('/ping') || endpoint.includes('/creative/task');
                const method = isGet ? 'GET' : 'POST';

                let options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    }
                };

                if (!isGet && body) {
                    try {
                        JSON.parse(body); // éªŒè¯JSONæ ¼å¼
                        options.body = body;
                    } catch (e) {
                        alert('è¯·æ±‚ä½“JSONæ ¼å¼é”™è¯¯: ' + e.message);
                        return;
                    }
                } else if (method === 'POST' && body) {
                    // å¯¹äºPOSTè¯·æ±‚ï¼Œå¦‚æœæœ‰bodyåˆ™ä½¿ç”¨å®ƒ
                    options.body = body;
                } else if (method === 'POST' && !body) {
                    // å¯¹äºPOSTè¯·æ±‚ï¼Œå¦‚æœæ²¡æœ‰bodyåˆ™ä½¿ç”¨ç©ºå¯¹è±¡
                    options.body = '{}';
                }

                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                sendText.textContent = 'è¯·æ±‚ä¸­...';
                loadingSpinner.style.display = 'inline-block';
                sendBtn.disabled = true;

                const startTime = Date.now();

                try {
                    const response = await fetch(url, options);

                    // é¦–å…ˆæ£€æŸ¥å“åº”å¤´æ˜¯å¦è¡¨ç¤ºæ˜¯JSON
                    const contentType = response.headers.get('content-type');
                    let data;

                    if (contentType && contentType.includes('application/json')) {
                        // å¦‚æœæ˜¯JSONå“åº”ï¼Œåˆ™ç›´æ¥è§£æ
                        try {
                            data = await response.json();
                        } catch (jsonError) {
                            // å¦‚æœJSONè§£æå¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
                            data = {
                                error: "Invalid JSON response received from server",
                                details: jsonError.message,
                                rawResponse: await response.text().catch(() => "Could not read response text")
                            };
                        }
                    } else {
                        // å¦‚æœä¸æ˜¯JSONå“åº”ï¼Œåˆ™è·å–æ–‡æœ¬
                        const text = await response.text();
                        try {
                            // å°è¯•è§£ææ–‡æœ¬ä¸ºJSON
                            data = JSON.parse(text);
                        } catch (parseError) {
                            // å¦‚æœæ–‡æœ¬ä¸æ˜¯JSONæ ¼å¼ï¼Œä½œä¸ºæ™®é€šæ–‡æœ¬è¿”å›
                            data = {
                                status: response.status,
                                statusText: response.statusText,
                                message: text,
                                error: "Response is not valid JSON format",
                                contentType: contentType || "unknown"
                            };
                        }
                    }

                    const duration = Date.now() - startTime;

                    // å®‰å…¨åœ°æ˜¾ç¤ºå“åº”ï¼Œå¦‚æœæ•°æ®å·²ç»æ˜¯å­—ç¬¦ä¸²å°±ä¸é‡å¤åºåˆ—åŒ–
                    if (typeof data === 'string') {
                        responseBody.textContent = data;
                    } else {
                        responseBody.textContent = JSON.stringify(data, null, 2);

                        // æ£€æŸ¥æ˜¯å¦æœ‰åˆ›æ„å›¾ç‰‡æ•°æ®ï¼Œç”¨äºé¢„è§ˆ
                        displayImagePreviews(data);
                    }

                    responseStatus.textContent = `${response.status} ${response.statusText}`;
                    responseStatus.className = 'status-badge';
                    if (response.ok) {
                        responseStatus.classList.add('status-success');
                    } else {
                        responseStatus.classList.add('status-error');
                    }
                    responseStatus.style.display = 'inline-block';
                    responseTime.textContent = `å“åº”æ—¶é—´: ${duration}ms`;
                    responseTime.style.display = 'block';
                } catch (error) {
                    const duration = Date.now() - startTime;

                    // æ›´è¯¦ç»†çš„é”™è¯¯å¤„ç†
                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        responseBody.textContent = `ç½‘ç»œé”™è¯¯: æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨\n\nè¯¦ç»†ä¿¡æ¯: ${error.message}`;
                    } else {
                        responseBody.textContent = `è¯·æ±‚é”™è¯¯: ${error.message}`;
                    }

                    responseStatus.textContent = 'è¯·æ±‚å¤±è´¥';
                    responseStatus.className = 'status-badge status-error';
                    responseStatus.style.display = 'inline-block';
                    responseTime.textContent = `å“åº”æ—¶é—´: ${duration}ms`;
                    responseTime.style.display = 'block';
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    sendText.textContent = 'å‘é€è¯·æ±‚';
                    loadingSpinner.style.display = 'none';
                    sendBtn.disabled = false;
                }
            });
        });

        function loadExample(endpoint, method) {
            document.getElementById('apiEndpoint').value = endpoint;
            document.getElementById('apiEndpoint').dispatchEvent(new Event('change'));

            if (method === 'POST') {
                const exampleBody = `{
  "title": "å¤å­£ä¿ƒé”€æ´»åŠ¨",
  "selling_points": ["5æŠ˜ä¼˜æƒ ", "é™æ—¶æŠ¢è´­", "ç‹¬å®¶ä¼˜æƒ "],
  "product_image_url": "https://example.com/product.jpg",
  "formats": ["image", "video"],
  "style": "bright",
  "cta_text": "ç«‹å³è´­ä¹°",
  "num_variants": 3
}`;
                document.getElementById('requestBody').value = exampleBody;
            }

            // æ»šåŠ¨åˆ°è¡¨å•ä½ç½®
            document.getElementById('apiForm').scrollIntoView({ behavior: 'smooth' });
        }

        // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
        function displayImagePreviews(data) {
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const imagePreview = document.getElementById('imagePreview');

            // æ¸…ç©ºä¹‹å‰çš„å†…å®¹
            imagePreview.innerHTML = '';

            // æ£€æŸ¥æ•°æ®ç»“æ„ï¼ŒæŸ¥æ‰¾åˆ›æ„å›¾ç‰‡
            let creatives = [];

            // å°è¯•ä¸åŒçš„æ•°æ®ç»“æ„è·¯å¾„
            if (data && data.data && data.data.creatives) {
                // æ ‡å‡†å“åº”æ ¼å¼: { code: 0, data: { creatives: [...] } }
                creatives = data.data.creatives;
            } else if (data && data.creatives) {
                // ç›´æ¥åŒ…å«creativesçš„æ•°æ®ç»“æ„
                creatives = data.creatives;
            } else if (data && data.data && Array.isArray(data.data)) {
                // æ•°ç»„æ ¼å¼
                creatives = data.data;
            }

            if (creatives && creatives.length > 0) {
                imagePreviewContainer.style.display = 'block';

                creatives.forEach(creative => {
                    // ä¼˜å…ˆä½¿ç”¨CDNURLï¼ˆå…¬å…±å›¾åºŠURLï¼‰ï¼Œç„¶åæ˜¯PublicURLï¼Œæœ€åæ˜¯image_url
                    let imageUrl = creative.cdn_url || creative.CDNURL || creative.public_url || creative.PublicURL || creative.image_url || creative.ImageURL;

                    // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡URL
                    if (imageUrl && isImageUrl(imageUrl)) {
                        const imageItem = document.createElement('div');
                        imageItem.className = 'image-item';

                        const img = document.createElement('img');
                        img.src = imageUrl;
                        img.alt = creative.title || creative.Title || 'åˆ›æ„å›¾ç‰‡';
                        img.loading = 'lazy'; // å»¶è¿ŸåŠ è½½ä»¥æé«˜æ€§èƒ½

                        // æ·»åŠ é”™è¯¯å¤„ç†ï¼Œä»¥é˜²å›¾ç‰‡åŠ è½½å¤±è´¥
                        img.onerror = function() {
                            this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200" viewBox="0 0 24 24"><rect width="24" height="24" fill="%23f0f0f0"/><text x="12" y="12" font-family="Arial" font-size="3" text-anchor="middle" fill="%23999">å›¾ç‰‡åŠ è½½å¤±è´¥</text></svg>';
                            this.alt = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                        };

                        const urlDiv = document.createElement('div');
                        urlDiv.className = 'image-url';
                        urlDiv.textContent = imageUrl;

                        imageItem.appendChild(img);
                        imageItem.appendChild(urlDiv);
                        imagePreview.appendChild(imageItem);
                    }
                });

                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä»»ä½•å›¾ç‰‡ï¼Œéšè—é¢„è§ˆå®¹å™¨
                if (imagePreview.children.length === 0) {
                    imagePreviewContainer.style.display = 'none';
                }
            } else {
                // æ²¡æœ‰åˆ›æ„å›¾ç‰‡ï¼Œéšè—é¢„è§ˆå®¹å™¨
                imagePreviewContainer.style.display = 'none';
            }
        }

        // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡URL
        function isImageUrl(url) {
            if (!url) return false;
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
            const lowerUrl = url.toLowerCase();
            return imageExtensions.some(ext => lowerUrl.includes(ext)) ||
                   url.startsWith('data:image') ||
                   /image/.test(lowerUrl);
        }

        // å…¨å±€å˜é‡
        let currentAssetsPage = 1;
        let totalAssetsPages = 1;
        let totalAssetsCount = 0;

        // æ˜¾ç¤ºç´ æç®¡ç†è§†å›¾
        function showAssetsView() {
            document.getElementById('apiTestSection').style.display = 'none';
            document.getElementById('assetsManagementSection').style.display = 'block';
            document.getElementById('responseSection').style.display = 'none'; // éšè—APIå“åº”éƒ¨åˆ†
            loadAssets(); // åŠ è½½ç´ æ
        }

        // æ˜¾ç¤ºAPIæµ‹è¯•è§†å›¾
        function showAPITestView() {
            document.getElementById('apiTestSection').style.display = 'block';
            document.getElementById('assetsManagementSection').style.display = 'none';
            document.getElementById('responseSection').style.display = 'block'; // æ˜¾ç¤ºAPIå“åº”éƒ¨åˆ†
        }

        // åŠ è½½ç´ æåˆ—è¡¨
        async function loadAssets() {
            showAssetsLoading(true);
            hideAssetsError();

            try {
                const format = document.getElementById('formatFilter').value;
                const taskID = document.getElementById('taskFilter').value;
                const pageSize = document.getElementById('pageSize').value;

                let url = `http://localhost:4000/api/v1/creative/assets?page=${currentAssetsPage}&page_size=${pageSize}`;
                if (format) url += `&format=${encodeURIComponent(format)}`;
                if (taskID) url += `&task_id=${encodeURIComponent(taskID)}`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.code !== 0) {
                    throw new Error(result.message || 'è·å–ç´ æå¤±è´¥');
                }

                displayAssets(result.data.assets);
                updateAssetsPagination(result.data.total, result.data.page, result.data.page_size, result.data.total_pages);

            } catch (error) {
                showAssetsError(`åŠ è½½ç´ æå¤±è´¥: ${error.message}`);
                console.error('Error loading assets:', error);
            } finally {
                showAssetsLoading(false);
            }
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadAssetsStats() {
            try {
                const response = await fetch('http://localhost:4000/api/v1/creative/assets?page=1&page_size=1', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.code === 0) {
                    document.getElementById('totalAssets').textContent = result.data.total || 0;
                    totalAssetsCount = result.data.total || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('totalAssets').textContent = 'åŠ è½½å¤±è´¥';
            }
        }

        // æ˜¾ç¤ºç´ æ
        function displayAssets(assets) {
            const container = document.getElementById('assetsContainer');

            if (!assets || assets.length === 0) {
                container.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #7f8c8d;">æ²¡æœ‰æ‰¾åˆ°ç´ æ</div>';
                return;
            }

            const html = assets.map(asset => `
                <div class="asset-card">
                    <img src="${asset.image_url}" alt="å¹¿å‘Šç´ æ" class="asset-image"
                         onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"250\" height=\"200\" viewBox=\"0 0 250 200\"><rect width=\"250\" height=\"200\" fill=\"%23f0f0f0\"/><text x=\"125\" y=\"100\" font-family=\"Arial\" font-size=\"12\" text-anchor=\"middle\" fill=\"%23999\">å›¾ç‰‡åŠ è½½å¤±è´¥</text></svg>'; this.alt='å›¾ç‰‡åŠ è½½å¤±è´¥'">
                    <div class="asset-info">
                        <div class="asset-id">${asset.id.substring(0, 8)}...</div>
                        <div class="asset-format">${asset.format}</div>
                        <div class="asset-dimensions">${asset.width} x ${asset.height}</div>
                        <div class="asset-url" title="${asset.image_url}">${truncateAssetUrl(asset.image_url)}</div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html;
        }

        // æˆªæ–­URLæ˜¾ç¤º
        function truncateAssetUrl(url) {
            if (url.length > 30) {
                return url.substring(0, 15) + '...' + url.substring(url.length - 15);
            }
            return url;
        }

        // æ›´æ–°åˆ†é¡µ
        function updateAssetsPagination(total, currentPageNum, pageSize, totalPagesNum) {
            totalAssetsCount = total;
            currentAssetsPage = currentPageNum;
            totalAssetsPages = totalPagesNum;

            const pagination = document.getElementById('pagination');

            let html = '';

            // ä¸Šä¸€é¡µæŒ‰é’®
            html += `<button class="page-btn" ${currentAssetsPage <= 1 ? 'disabled' : ''} onclick="goToAssetsPage(${currentAssetsPage - 1})">ä¸Šä¸€é¡µ</button>`;

            // é¡µç æŒ‰é’®
            const startPage = Math.max(1, currentAssetsPage - 2);
            const endPage = Math.min(totalAssetsPages, currentAssetsPage + 2);

            if (startPage > 1) {
                html += `<button class="page-btn" onclick="goToAssetsPage(1)">1</button>`;
                if (startPage > 2) html += `<span>...</span>`;
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="page-btn" ${i === currentAssetsPage ? 'style="background: #2c3e50;"' : ''} onclick="goToAssetsPage(${i})">${i}</button>`;
            }

            if (endPage < totalAssetsPages) {
                if (endPage < totalAssetsPages - 1) html += `<span>...</span>`;
                html += `<button class="page-btn" onclick="goToAssetsPage(${totalAssetsPages})">${totalAssetsPages}</button>`;
            }

            // ä¸‹ä¸€é¡µæŒ‰é’®
            html += `<button class="page-btn" ${currentAssetsPage >= totalAssetsPages ? 'disabled' : ''} onclick="goToAssetsPage(${currentAssetsPage + 1})">ä¸‹ä¸€é¡µ</button>`;

            // é¡µç ä¿¡æ¯
            html += `<div class="current-page">ç¬¬ ${currentAssetsPage} é¡µï¼Œå…± ${totalAssetsPages} é¡µ (${totalAssetsCount} é¡¹)</div>`;

            pagination.innerHTML = html;

            // æ›´æ–°ç»Ÿè®¡æ•°æ®
            document.getElementById('totalAssets').textContent = total;
        }

        // è·³è½¬åˆ°æŒ‡å®šé¡µ
        function goToAssetsPage(page) {
            if (page < 1 || page > totalAssetsPages || page === currentAssetsPage) return;
            currentAssetsPage = page;
            loadAssets();
        }

        // åˆ·æ–°ç´ æ
        function refreshAssets() {
            loadAssets();
            loadAssetsStats();
        }

        // æ¸…ç©ºç­›é€‰æ¡ä»¶
        function clearFilters() {
            document.getElementById('formatFilter').value = '';
            document.getElementById('taskFilter').value = '';
            document.getElementById('pageSize').value = '24';
            currentAssetsPage = 1;
            loadAssets();
        }

        // æ˜¾ç¤º/éšè—ç´ æåŠ è½½çŠ¶æ€
        function showAssetsLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // æ˜¾ç¤ºç´ æé”™è¯¯ä¿¡æ¯
        function showAssetsError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        // éšè—ç´ æé”™è¯¯ä¿¡æ¯
        function hideAssetsError() {
            document.getElementById('error').style.display = 'none';
        }

        // æŒ‰å›è½¦é”®æœç´¢
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('assetsManagementSection').style.display === 'block') {
                loadAssets();
            }
        });
    </script>
</body>
</html>